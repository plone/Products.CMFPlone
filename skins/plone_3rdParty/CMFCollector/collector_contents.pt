<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<tal:block condition="nothing">
  Template description: Batching view of the collector issues.
</tal:block>

<body>

<div metal:fill-slot="header"
     tal:define="global collector_header_present python: 1">

    <div metal:use-macro="here/collector_macros/macros/collector_header">
    COLLECTOR HEADER
    </div>

</div>

<div metal:fill-slot="main">

<div tal:condition="not: collector_header_present|nothing">
  <!-- Master template has no "header" macro... -->
    <div metal:use-macro="here/collector_macros/macros/collector_header">
    COLLECTOR HEADER
    </div>
</div>

<div tal:define="Batch python:modules['Products.CMFPlone'].Batch;
                 pysutil modules/Products.PythonScripts.standard;
                 strmod modules/string;
                 cap nocall: strmod/capitalize;
                 split nocall: strmod/split;
                 DateTime nocall: modules/DateTime/DateTime;
                 BATCHSIZE python: 10;
                 TITLELEN python: 110;
                 DESCRLEN python: 200;
                 b_start python: request.get('b_start', 0);
                 searching
                    python: (request.get('searching') != 'yep'
                             and (request.set('status',
                                              ['Pending', 'Accepted'])));
                 items here/collector_search;
                 batch python: Batch(items, BATCHSIZE, int(b_start), orphan=0);">

    <div tal:define="total here/length;
                     found python:len(items);"
         i18n:translate="collector_issue_number">
        Found
        <span tal:replace="found" i18n:name="found">found</span>
        issues. In total there are
        <span tal:replace="total" i18n:name="total">total</span>
        issues in this collector.
    </div>

    <!-- Navigation -->
    <div metal:use-macro="here/batch_macros/macros/navigation" />


    <table id="sortable" class="listing">
      <thead>
      <tr>
        <th>&nbsp;<span tal:omit-tag="" i18n:translate="listingheader_issue">Issue</span>&nbsp;</th>
        <th>&nbsp;<span tal:omit-tag="" i18n:translate="listingheader_title">Title</span>&nbsp;</th>
        <th>&nbsp;<span tal:omit-tag="" i18n:translate="listingheader_submitter">Submitter</span>&nbsp;</th>
        <th>&nbsp;<span tal:omit-tag="" i18n:translate="listingheader_date">Date</span>&nbsp;</th>
        <th>&nbsp;<span tal:omit-tag="" i18n:translate="listingheader_status">Status</span>&nbsp;</th>
      </tr>
      </thead>

      <tbody>
        <metal:block tal:repeat="itemnum python: range(len(batch))">
        <tr tal:define="oddrow repeat/itemnum/odd"
                      tal:attributes="class python:test(oddrow, 'even', 'odd')">
        <metal:block tal:define="global item python:batch[itemnum];
                        itemurl item/getURL;
                        itemtype item/getId|nothing;
                        icon item/getIcon|item/icon|nothing;
                        odd repeat/itemnum/odd;
                        global alternatingcolor python:
                                                ['#ffffff', '#eeeeee'][odd]">

          <td>
            <a href="ITEMURL" tal:attributes="href itemurl">
              <span tal:replace="item/id">ID</span>
            </a>
          </td>

          <td>
            <a href="ITEMURL" tal:attributes="href itemurl">
                <img src="" alt="Issue" border="0"
                     tal:condition="icon"
                     tal:attributes="src icon" />
                <span tal:replace="itemtype"
                      tal:condition="not: icon"></span>

                <span tal:condition="item/Title"
                      tal:replace="python:
                                   item.Title[:TITLELEN]
                                   + (item.Title[TITLELEN:] and '...')">
                  TITLE
                </span>
            </a>
          </td>

        </metal:block>

        <metal:block tal:define="crdate item/created;
                                 moddate item/modified;
                                 global numcmts python: int(item.action_number)-1;
                                 datesdiff python: ((moddate - crdate) * 86400) > 30">

          <td>

            <span tal:replace="item/submitter_id|nothing">SUBMITTER ID</span
              ><span tal:condition="numcmts"></span>
            <span tal:condition="not: item/submitter_id|nothing">?</span>
          </td>

          <td>
            <span tal:replace="python: here.aCompact(crdate)">CREATEDATE
              </span><span tal:condition="python: datesdiff"> ...
                <span tal:replace="python: here.aCompact(moddate)">
                  MODDATE</span>
            </span>
          </td>

        </metal:block>

        <metal:block tal:define="security python: item.security_related;
                                 confidential python: split(item.status, '_')[-1]
                                                      == 'confidential';">
          <td style="white-space: nowrap">

            <!-- The color indicates whether the item is security-related, and
                  parenthesizing indicates that a security-related item has not
                  yet reached a completed state, ie is still confidential. -->
            <font color="SECURITY COLOR"
                  tal:attributes="color python:
                                        (security and 'brown' or 'black')">
                <span i18n:translate=""
		              tal:content="python: (confidential and '(' or '')
                                           + cap(split(item.status,
                                                       '_')[0])
                                           + (confidential and ')' or '')">
                  STATUS</span>
            </font>

            <br />

            <span tal:replace="python: '%s %s'
                                       % (item.topic, item.classification)">
              TOPIC/CLASSIFICATION
            </span>

            <br />

            <span tal:omit-tag="" i18n:translate=""><span tal:replace="item/importance">
              Importance
            </span></span>

            <span tal:condition="item/assigned_to|nothing"
	              i18n:translate="collector_issue_assigned_to">,
              Assigned to

              <span tal:content="python: ', '.join(item.assigned_to)" i18n:name="names">
                SUPPORTERS
              </span>
            </span>
          </td>

        </metal:block>
        </tr>
      </metal:block>
      </tbody>

    </table>

    <!-- Navigation -->
    <div metal:use-macro="here/batch_macros/macros/navigation" />


    <form class="group"
          action="RETURNHERE" method="get"
          tal:attributes="action python: here.absolute_url()
                                         + '/collector_contents'"
          tal:define="uniquevals python:
                                 here.get_internal_catalog().uniqueValuesFor;
                      ordered nocall: here/collector_ordered_traits">
      <input type="hidden" name="searching" value="yep" />

      <span class="legend" i18n:translate="legend_search_for_issues">Search for issues</span>

      <div class="row">
          <div class="label" i18n:translate="label_contains">Contains</div>

          <div class="field">
             <input type="text" name="SearchableText" size="40"
                    value="TEXT"
                    tal:attributes="value request/SearchableText|nothing" />
          </div>
      </div>

      <div class="row">
          <div class="label">&nbsp;</div>

          <div class="field">
                <table>

                  <tr>
                    <th i18n:translate="listingheader_status">Status</th>
                    <th i18n:translate="listingheader_requester">Requester</th>
                    <th i18n:translate="listingheader_assigned">Assigned</th>
                    <th i18n:translate="listingheader_security_related">Security Related</th>
                  </tr>
                  <tr>
                    <td>
                      <select name="status:list:ignore_empty" multiple size="SIZE"
                            tal:define="values here/collector_issue_trim_states"
                            tal:attributes="size python: min(max(len(values), 3), 5)">
                        <option value="" i18n:translate=""
                                tal:repeat="status values"
                                tal:attributes="value status;
                                                selected python: status
                                                       in request.get('status', [])"
                                tal:content="status">
                        </option>
                     </select>
                    </td>
                    <td>
                      <select name="Creator:list:ignore_empty" multiple size="SIZE"
                              tal:define="values python: uniquevals('Creator')"
                              tal:attributes="size python: min(max(len(values), 3),
                                                               5)">
                        <option value=""
                                tal:repeat="creator values"
                                tal:attributes="
                                    value creator;
                                    selected python: creator
                                                     in request.get('Creator', [])"
                                tal:content="creator">
                        </option>
                      </select>
                    </td>
                    <td>
                      <select name="supporters:list:ignore_empty" multiple size="SIZE"
                              tal:define="values python:
                                                 ordered(uniquevals('assigned_to'),
                                                         here.supporters)"
                              tal:attributes="size python: min(max(len(values), 3),
                                                               5)">
                        <option value=""
                                tal:repeat="supporter values"
                                tal:attributes="
                                    value supporter;
                                    selected python: supporter
                                             in request.get('supporters', [])"
                                tal:content="supporter">
                        </option>
                      </select>
                    </td>
                    <td>
                      <select name="security_related:list:ignore_empty" size="3" multiple
                              tal:define="was python: request.get('security_related',
                                                                  [])">
                        <option value="No" i18n:translate=""
                                tal:attributes="selected python: 'No' in was">
                          No </option>
                        <option value="Yes" i18n:translate=""
                                tal:attributes="selected python: 'Yes' in was">
                          Yes </option>
                      </select>
                    </td>

                  </tr>
                  <tr>
                    <th i18n:translate="listingheader_topic">Topic</th>
                    <th i18n:translate="listingheader_classification">Classification</th>
                    <th i18n:translate="listingheader_importance">Importance</th>
                    <th> &nbsp; </th>
                  </tr>
                  <tr>
                    <td>
                      <select name="topics:list:ignore_empty" multiple size="SIZE"
                            tal:define="values python: ordered(uniquevals('topic'),
                                                               here.topics)"
                            tal:attributes="size python: min(max(len(values), 3), 5)">
                        <option value=""
                                tal:repeat="topic values"
                                tal:attributes="
                                    value topic;
                                    selected python: topic
                                                     in request.get('topics', [])"
                                tal:content="topic">
                        </option>
                     </select>
                    </td>
                    <td>
                      <select name="classifications:list:ignore_empty" multiple size="SIZE"
                              tal:define="values python:
                                                 ordered(uniquevals('classification'),
                                                         here.classifications)"
                              tal:attributes="size python: min(max(len(values), 3),
                                                               5)">
                        <option value="" i18n:translate=""
                                tal:repeat="classification values"
                                tal:attributes="
                                   value classification;
                                   selected python: classification
                                                    in request.get('classifications',
                                                                   [])"
                                tal:content="classification">
                        </option>
                      </select>
                    </td>
                    <td>
                      <select name="importances:list:ignore_empty" multiple size="SIZE"
                              tal:define="values python:
                                                 ordered(uniquevals('importance'),
                                                         here.importances)"
                              tal:attributes="size python: min(max(len(values), 3),
                                                               5)">
                        <option value="" i18n:translate=""
                                tal:repeat="importance values"
                                tal:attributes="
                                    value importance;
                                    selected python: importance
                                                     in request.get('importances',
                                                                    [])"
                                tal:content="importance">
                        </option>
                     </select>
                  </td>

                  <td>
                  &nbsp;
                  </td>

                </tr>


              </table>
        </div>
     </div>

     <div class="row">

        <div class="label">&nbsp;</div>

        <div class="field">
            <input class="context" type="Submit" value="Search" i18n:attributes="value" />
            <input class="standalone" type="reset" value="Reset" i18n:attributes="value" />
        </div>
    </div>

</form>

</div>
</div>
</body>
</html>
