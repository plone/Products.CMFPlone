<html xmlns:tal="http://xml.zope.org/namespaces/tal"
       xmlns:metal="http://xml.zope.org/namespaces/metal"
       metal:use-macro="here/main_template/macros/master">

<body>

<div metal:fill-slot="header"
     tal:define="global wiki_header_present python:1">

    <div tal:replace="structure here/wikipage_header">
    </div>

</div>

<div metal:fill-slot="main">


    <div tal:condition="not: wiki_header_present|nothing">

        <span tal:condition="nothing"> In case master has no "header" macro. </span>
        <div tal:replace="structure here/wikipage_header"> </div>

    </div>

    <div tal:define="mode python: request.get( 'mode', 'condensed' );
                     editor python: here.isAllowed('edit');
                     b_start python: int( request.get( 'b_start', 0 ) );
                     b_size  python: int( request.get( 'b_size', 20 ) );
                     b_end   python: b_start + b_size;
                     batch   python: here.get_page_history( mode=mode
                                                          , batchsize=b_size
                                                          , first=b_start
                                                          , last=b_end
                                                          );
                     b_more  python: len( batch ) >= b_size">

        <h1>
            <span tal:replace="python: modules['string'].capitalize( mode )">Mode</span>

            Change History for
            <span tal:replace="here/getId">
                Page ID
            </span>
        </h1>

        <p> This is a <span tal:replace="mode">condensed</span> record of
            <span tal:replace="here/getId">Page ID</span>'s historical
            versions.  You can view old versions by clicking on the
            links<span tal:condition="python: not editor"> and view difference-style
            comparisons between them.</span><span tal:condition="editor">, view
            difference-style comparisons between them, and bring copies of old
            versions out of the past to serve as the current one.</span>
        </p>

        <div tal:condition="python: mode=='condensed'">
            <p> This condensed listing omits "interim" versions: versions of the
                page that lack a log message, and that were replaced with a new
                version by the same editor, within thirty minutes after the edits
                were committed.
            </p>
            <p> You can visit <a href="wikipage_history"
                  tal:attributes="href string: wikipage_history?mode=complete"
                >the complete listing</a>, instead of this condensed one.
            </p>
        </div>

        <div tal:condition="python: mode!='condensed'">
          <p>
          You can also visit <a href="wikipage_history">a
          condensed listing</a>, which omits intermediate page versions.
          </p>
        </div>

        <form method="post" tal:attributes="action here/absolute_url">

            <!-- list navigation -->
            <div class="listingBar"
                 tal:condition="python: (b_start > 0) or b_more">
                <span class="previous"
                      tal:condition="python: b_start > 0">

                    <span tal:define="b_prev python: max( b_start-b_size, 0 );
                                      q_mode string:mode=${mode};
                                      q_start string:b_start=${b_prev};
                                      q_size  string:b_size=${b_size};
                                      q       string:${q_mode}&${q_start}&${q_size};
                                     ">
                    <a href="wikipage_history"
                       tal:attributes="href string:wikipage_history?${q}"
                    > &laquo; More Recent Revisions </a>
                    </span>
                </span>

                <span class="next"
                      tal:condition="b_more">
                    <span tal:define="q_mode string:mode=${mode};
                                     q_start string:b_start=${b_end};
                                     q_size  string:b_size=${b_size};
                                     q       string:${q_mode}&${q_start}&${q_size};
                                    ">
                    <a href="wikipage_history"
                       tal:attributes="href string:wikipage_history?${q}"
                    > Less Recent Revisions &raquo; </a>
                    </span>
                </span>
            </div>

            <!-- result listing -->
            <table class="listing">
                <thead>
                    <tr>
                        <th>Index</th>
                        <th>Date/Author</th>
                        <th>Action Performed</th>
                        <th>Log Message</th>
                        <th>Revision</th>
                    </tr>
                </thead>

                <tbody>
                    <tr tal:repeat="trans batch">

                        <td>
                            <!-- Do we want this?
                            <span style="color: gray">-<span tal:replace="trans/tacked_on_index">?</span></span>
                            -->
                            <input type="checkbox"
                                   class="noborder"
                                   name="keys:list"
                                   tal:attributes="value trans/key" />
                        </td>

                        <td>
                            <a href="history"
                              tal:attributes="href
                                string:${here/absolute_url}/HistoricalRevisions/${trans/key}"
                            ><span tal:replace="python: trans['time'].Mon()">Jan</span>
                             <span tal:replace="python: trans['time'].day()">01</span>
                             <span tal:replace="python: trans['time'].Time()">08:00:00</span>
                             by
                             <span tal:condition="trans/user_name"
                                   tal:replace="trans/user_name">user</span>
                            </a>

                            <span tal:condition="python: trans['tacked_on_index'] == 0">
                                <strong>(Current)</strong>
                            </span>
                        </td>

                        <span tal:define="descr python:modules['string'].split( trans['description']
                                                                                 , '\012\012'
                                                                                 )">
                            <td>
                                <span tal:replace="python:descr[0]">method</span>
                            </td>

                            <td>
                                <span tal:repeat="more python:descr[1:]">
                                        <span tal:replace="more" />
                                </span>
                            </td>
                        </span>

                        <td>
                            <span tal:condition="exists: trans/revision"
                                  tal:replace="trans/revision">
                            Revision
                            </span>

                            <span tal:condition="not: exists: trans/revision">
                            &nbsp;
                            </span>
                        </td>
                    </tr>
                </tbody>

            </table>

            <input type="submit"
                   class="context"
                   name="wikipage_compare_versions:method"
                   value="Compare" />
            <span tal:condition="editor">
                 &nbsp; &nbsp;
                 <input type="submit"
                        class="context"
                        name="wikipage_copyhistory_handler:method"
                        value="Copy to present" />
            </span>


        </form>

    </div>

</div>


</body>
</html>
