<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

  <metal:block fill-slot="top_slot">
    <metal:block tal:define="dummy python:request.RESPONSE.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate, post-check=0, pre-check=0');
                             dummy python:request.set('enable_border', 1);" />
  </metal:block>

  <metal:calendar fill-slot="javascript_head_slot">
    <!-- ECMAScript calendar -->
    <style type="text/css" media="all"
	    tal:content="string:@import url($portal_url/jscalendar/calendar-system.css);"></style>
    <script type="text/javascript"
	    tal:attributes="src string:$portal_url/jscalendar/calendar_stripped.js"></script>
    <script type="text/javascript" charset="iso-8859-1"
	    tal:condition="exists: portal/jscalendar/calendar-en.js"
	    tal:attributes="src string:$portal_url/jscalendar/calendar-en.js"></script>
  </metal:calendar>

  <body>

    <!--
      NOTE: This form is used in two different ways - from folder_contents,
      allowing you to publish several things at once, and from the state
      drop-down. In the first case, the 'paths' request parameter is set;
      in the second case, giving the relative paths to the content object
      to manipulate; in the second case, this parameter is omitted and the
      path of the context is used.
    -->

    <div metal:fill-slot="main"
         tal:define="errors options/state/getErrors;
                     review_state wf_state;
                     paths python:request.get('paths', ['/'.join(here.getPhysicalPath())]);
                     batch python:here.getObjectsFromPathList(paths,batch=True);
                     folders_in_publishing python:[o.getId for o in batch if o.isPrincipiaFolderish];
                     came_from python:request.get('HTTP_REFERER', here.absolute_url()).split('?')[0];
                     dummy python:request.set('orig_template', came_from);
                     ">

      <metal:block tal:condition="python: paths and not batch"
                   tal:replace="python:here.redirectToReferrer('The item(s) you selected are no longer available.')"/>

      <h1 i18n:translate="heading_publishing_process">Publishing process</h1>

      <p i18n:translate="description_publishing_process">
        An item's status (also called its review state) determines who
        can see it.  A <strong>private</strong> item can only be
        viewed by its Owner and by the site management. Only
        <strong>published</strong> items are available to the general
        member base and anonymous visitors. To make an item published,
        it has to be reviewed by one of the site's Reviewers. You can
        request that an item be reviewed by <strong>submitting it for
        review</strong>.
        <br />
        Another way to control the visibility of an item is with its
        <strong>effective date</strong>. An item is not publicly
        searchable before its effective date, <em>even if its status is
        <strong>published</strong></em>.  This will prevent the item
        from showing up in portlets (or any other templates fed by catalog
        queries), although the item will still be available if accessed 
        directly via URL.
      </p>

      <form id="edit_form"
            name="edit_form"
            method="post"
            action="content_status_modify"
            tal:attributes="action string:${here/absolute_url}/${template/getId}"
            tal:condition="not:python:paths and not batch">

        <fieldset>

          <legend i18n:translate="legend_publishing_details">Publishing Details</legend>

          <div class="field" tal:condition="batch">
            <label for="" i18n:translate="label_affected_content">Affected content</label>
            <div tal:define="dummy python:request.set('ids_checked', 1);">
              <table summary="" metal:use-macro="here/folder_contents/macros/folder_listing">
              </table>
            </div>
          </div>

          <div class="field formSingleCheckbox"
               tal:condition="folders_in_publishing|nothing">

            <label for="include_contained_objects" i18n:translate="label_include_contained_objects">
              Include folder items
            </label>

            <div class="formHelp"
                 i18n:translate="help_include_contained_objects">
              If checked, Plone will attempt to modify the status of all content 
              in any selected folders and their subfolders.
            </div>

            <input type="checkbox"
                   class="formElement"
                   id="include_children"
                   name="include_children"
                   tabindex=""
                   tal:attributes="tabindex tabindex/next;"
                   />
          </div>

          <div class="field" tal:define="error errors/effective_date | nothing;">
            <label i18n:translate="label_effective_date">Effective Date</label>
            <div class="formHelp"
                 i18n:translate="help_effective_date">
              The date when the item will be available (of course it
              needs to be published too).  If no date is selected the
              item will be effective immediately.
            </div>

            <div tal:content="error">Validation error output</div>

            <div tal:define="inputname  string:effective_date;
                             formname   string:edit_form;
                             effective here/EffectiveDate;
                             inputvalue python:test(effective and effective!='None', effective, request.get('effective_date', ''));
                             tabindex tabindex/next;"
                 tal:attributes="class python:test(error, 'field error', 'field')">

              <div metal:use-macro="here/calendar_slot/macros/calendarDatePickerBox">
                calendar pop-up
              </div>

            </div>
          </div>

          <div class="field"
               tal:define="error errors/expiration_date | nothing;">
            <label i18n:translate="label_expiration_date">Expiration Date</label>
            <div class="formHelp"
                 i18n:translate="help_expiration_date">
              The date when the item expires. This will automatically
              make the item invisible for others at the given date.
              If no date is chosen, it will never expire.
            </div>

            <div tal:content="error">Validation error output</div>

            <div class="field">
              <div tal:define="inputname  string:expiration_date;
                               formname   string:edit_form;
                               expiration here/ExpirationDate;
                               inputvalue python:test(expiration and expiration!='None', expiration, request.get('expiration_date', ''));
                               tabindex tabindex/next;"
                   tal:attributes="class python:test(error, 'field error', 'field')">

                <div metal:use-macro="here/calendar_slot/macros/calendarDatePickerBox">
                  calendar pop-up
                </div>
              </div>
            </div>
          </div>

          <div class="field">
            <label i18n:translate="label_comments">Comments</label>

            <div class="formHelp"
                 i18n:translate="help_publishing_comments">
              Will be added to the publishing history. If multiple
              items are selected, this comment will be attached to all
              of them.
            </div>
            <textarea id="comment"
                      name="comment"
                      cols="60"
                      rows="5"
                      tabindex=""
                      tal:attributes="tabindex tabindex/next;"
                      tal:content="request/comment|nothing"
                      ></textarea>
          </div>

          <div class="field">
            <label i18n:translate="label_change_status">Change State</label>
            <div class="formHelp"
                 i18n:translate="help_change_status">
              Select the new state for the selected items.
            </div>

            <div tal:define="tabindex tabindex/next;
                             error_workflow_action errors/workflow_action|nothing;
                             objs request/paths|nothing;
                             review_state_label string:No change;
                             target python:test(objs, objs, here);"
                 tal:attributes="class python:test(error_workflow_action, 'field error', 'field')">

              <div tal:condition="error_workflow_action">
                <tal:block i18n:translate="text_error" content="error_workflow_action">Error</tal:block>
                <br />
              </div>

              <span tal:replace="nothing">
                For usability we will want to signify what state we
                are currently in. DCWorkflow only returns what t
                ransitions are available.  But we want to visually
                represent what *state* we are currently in along with
                possible transitions.
              </span>

              <input class="noborder"
                     id=""
                     type="radio"
                     name="workflow_action"
                     title=""
                     value=""
                     tal:attributes="value review_state;
                                     title review_state;
                                     checked python:test(request.get('workflow_action', review_state)==review_state,1,0);" />
              <label for=""
                     i18n:translate=""
                     tal:attributes="for review_state;"
                     tal:content="review_state_label"
                     >Transition Name</label>
                     <br />

                     <tal:block define="global transitions python:wtool.getTransitionsFor(target, here)"
                                repeat="transition transitions">
                       <input class="noborder"
                              id=""
                              type="radio"
                              name="workflow_action"
                              title=""
                              value=""
                              i18n:attributes="title"
                              tal:attributes="value transition/id;
                                              id    transition/id;
                                              title transition/name;
                                              checked python:test(transition.get('id') == request.get('workflow_action', ''), 'checked', None)" />
                       <label for=""
                              i18n:translate=""
                              tal:attributes="for transition/id;"
                              tal:content="transition/name"
                              >Transition Name</label>
                              <br />
                     </tal:block>

            </div>

          </div>

          <div class="formControls">
            <input class="context"
                   type="submit"
                   name="form.button.Publish"
                   value="Save"
                   i18n:attributes="value"
                   tal:attributes="tabindex tabindex/next;"
                   tal:condition="not:request/paths|nothing"/>
            <input class="context"
                   type="submit"
                   name="form.button.FolderPublish"
                   value="Save"
                   i18n:attributes="value"
                   tal:attributes="tabindex tabindex/next;"
                   tal:condition="request/paths|nothing"/>
            <input class="standalone"
                   type="submit"
                   name="form.button.Cancel"
                   value="Cancel"
                   i18n:attributes="value"
                   tal:attributes="tabindex tabindex/next;"/>
          </div>


          <span tal:replace="nothing">
            ##### HIDDEN VARIABLES FOR THE FORM_TOOL -- CUT AND PASTE
            THESE INTO YOUR FORM ####
          </span>
          <input type="hidden" name="form.submitted" value="1" />
          <input type="hidden" name="orig_template"
                 tal:condition="request/orig_template|nothing"
                 tal:attributes="value request/orig_template"/>

        </fieldset>

      </form>

      <div tal:condition="not: request/paths|nothing">

        <table class="listing nosort" summary="Review History"
               i18n:attributes="summary"
               tal:define="review_history python:wtool.getInfoFor(here, 'review_history', []);
                                review_history python:[review for review in review_history if review.get('action','')]"
               tal:condition="review_history">

          <tr>
            <th i18n:translate="listingheader_action">Action</th>
            <th i18n:translate="listingheader_performed_by">Performed&nbsp;by</th>
            <th i18n:translate="listingheader_date_and_time">Date&nbsp;and&nbsp;Time</th>
            <th i18n:translate="listingheader_comment">Comment</th>
          </tr>

          <metal:block tal:define="review_history python: portal.reverseList(review_history);"
                       tal:repeat="items review_history">
            <tr tal:define="odd repeat/items/odd;
                            rhComments items/comments;"
                tal:attributes="class python:test(odd, 'even', 'odd')"
                tal:condition="items/action">
              <td i18n:translate="" tal:content="items/action">
                action
              </td>

              <td>
                <a href="/Members/runyaga"
                   tal:attributes="href python: mtool.getHomeUrl(items.get('actor'), '')"
                   tal:content="items/actor">
                  runyaga
                </a>
              </td>

              <td>
                <span tal:replace="python: items['time']" />
                <span tal:condition="items/effective_date|nothing">
                  (<span i18n:translate="label_publishing_effective" tal:omit-tag="">effective</span>:
                  <span tal:replace="python: items['effective_date']"></span>)
                </span>
              </td>

              <td>
                <span tal:condition="rhComments">
                  <span tal:replace="rhComments"> some comments </span>
                </span>

                <span tal:condition="not: rhComments" i18n:translate="no_comments">
                  No comments.
                </span>
              </td>
            </tr>
          </metal:block>
        </table>

      </div>

      <div metal:use-macro="here/document_byline/macros/byline">
        Get the byline - contains details about author and modification date.
      </div>

    </div>

  </body>
</html>
