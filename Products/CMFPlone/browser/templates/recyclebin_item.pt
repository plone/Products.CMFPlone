<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">
<body>

<metal:override fill-slot="top_slot">
  <tal:block define="dummy python:request.set('disable_border', 1);
                     dummy python:request.set('disable_plone.leftcolumn', 1);
                     dummy python:request.set('disable_plone.rightcolumn', 1)" />
</metal:override>

<metal:main fill-slot="main">
    <div class="container-fluid px-0">
        <tal:item define="item view/get_item;
                         form_context nocall:context">
            <!-- Item not found message -->
            <div tal:condition="not:item" class="card border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <span class="ms-2" i18n:translate="">Item not found</span>
                </div>
                <div class="card-body p-4 text-center">
                    <div class="mb-4">
                        <h2 class="mt-3" i18n:translate="">The requested item was not found</h2>
                        <p class="text-muted" i18n:translate="">
                            The requested item was not found in the recycle bin. It may have been already restored or deleted.
                        </p>
                    </div>
                    <a tal:attributes="href string:${context/absolute_url}/@@recyclebin" 
                       class="btn btn-primary" i18n:translate="">
                        <span class="ms-1">Return to recycle bin</span>
                    </a>
                </div>
            </div>
            
            <!-- Item found - display details -->
            <div tal:condition="item">
                <!-- Header with back button -->
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div class="d-flex align-items-center">
                        <a tal:attributes="href string:${context/absolute_url}/@@recyclebin" 
                           class="btn btn-sm btn-outline-secondary me-3">
                            <span class="ms-1" i18n:translate="">Back to recycle bin</span>
                        </a>
                        <h1 class="documentFirstHeading mb-0">
                            <span tal:content="item/title">Title</span>
                            <span class="badge rounded-pill bg-light text-dark border ms-2" tal:content="item/type">Content type</span>
                        </h1>
                    </div>
                </div>
                
                <!-- Comment-specific information -->
                <tal:comment-info condition="python:item.get('type') in ('CommentTree', 'Discussion Item')">
                    <div class="alert alert-info mb-4">
                        <span class="ms-2" i18n:translate="">
                            <span tal:condition="python:item.get('type') == 'CommentTree'" i18n:translate="">Comment thread</span>
                            <span tal:condition="python:item.get('type') == 'Discussion Item'" i18n:translate="">Comment</span>
                            <span i18n:translate="">deleted from</span>
                            <strong tal:condition="python:context.unrestrictedTraverse(item['parent_path'].split('/'), None)">
                                <a tal:attributes="href item/parent_path" 
                                   class="alert-link"
                                   tal:content="python:context.unrestrictedTraverse(item['parent_path'].split('/'), default='Content Object').Title()">
                                   Content title
                                </a>
                            </strong>
                            <strong tal:condition="python:not context.unrestrictedTraverse(item['parent_path'].split('/'), None)" i18n:translate="">
                                content that no longer exists
                            </strong>
                        </span>
                    </div>
                </tal:comment-info>
                
                <div class="row">
                    <!-- Left column: Item details -->
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <span class="ms-2" i18n:translate="">Item details</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <tbody>
                                            <tr>
                                                <th class="bg-light" width="30%" i18n:translate="">Original ID</th>
                                                <td class="text-monospace" tal:content="item/id">ID</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light" i18n:translate="">Original path</th>
                                                <td>
                                                    <span class="text-monospace ms-1" tal:content="item/path">Path</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light" i18n:translate="">Parent path</th>
                                                <td>
                                                    <span class="text-monospace ms-1" tal:content="item/parent_path">Parent</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light" i18n:translate="">Deletion date</th>
                                                <td>
                                                    <span class="ms-1" tal:content="python:context.restrictedTraverse('@@plone').toLocalizedTime(item['deletion_date'], long_format=True)">Date</span>
                                                </td>
                                            </tr>
                                            
                                            <!-- Comment-specific fields -->
                                            <tal:comment-fields condition="python:item.get('type') == 'Discussion Item'">
                                                <tr tal:condition="python:getattr(item['object'], 'text', None)">
                                                    <th class="bg-light" i18n:translate="">Comment text</th>
                                                    <td>
                                                        <div class="p-3 bg-light rounded">
                                                            <div class="text-content" tal:content="structure python:item['object'].getText()">Comment text</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr tal:condition="python:getattr(item['object'], 'author_name', None) or getattr(item['object'], 'author_username', None)">
                                                    <th class="bg-light" i18n:translate="">Comment author</th>
                                                    <td>
                                                        <span class="ms-1" tal:content="python:item['object'].author_name or item['object'].author_username">Author</span>
                                                    </td>
                                                </tr>
                                            </tal:comment-fields>
                                            
                                            <!-- Collection/folder children count -->
                                            <tr tal:condition="python:'children_count' in item">
                                                <th class="bg-light" i18n:translate="">Number of items</th>
                                                <td>
                                                    <span class="badge bg-secondary me-1" tal:content="item/children_count">Count</span>
                                                    <span i18n:translate="">contained items</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right column: Actions -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <span class="ms-2" i18n:translate="">Restore item</span>
                            </div>
                            <div class="card-body">
                                <form method="post" 
                                      enctype="multipart/form-data"
                                      class="pat-formunloadalert"
                                      tal:attributes="action string:${context/absolute_url}/@@recyclebin-item/${view/item_id}">
                                    
                                    <input tal:replace="structure context/@@authenticator/authenticator" />
                                    
                                    <div class="mb-3">
                                        <label for="form-widgets-target_container" class="form-label fw-bold" i18n:translate="">Custom restore location</label>
                                        <input type="text" name="form.widgets.target_container" id="form-widgets-target_container" 
                                               class="form-control text-widget textline-field" />
                                        <div class="form-text">
                                            <span class="ms-1" i18n:translate="">Leave blank to restore to the original location if it still exists.</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" type="submit" name="form.buttons.restore" i18n:translate="">
                                            <span class="ms-1">Restore item</span>
                                        </button>
                                        <button class="btn btn-danger" type="submit" name="form.buttons.delete"
                                               onclick="return confirm(translate('Are you sure you want to permanently delete this item?'));" 
                                               i18n:translate="">
                                            <span class="ms-1">Permanently delete</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="card-footer bg-light text-center">
                                <div class="text-muted">
                                    <small class="ms-1" i18n:translate="">Deleted on:</small>
                                    <span tal:content="python:context.restrictedTraverse('@@plone').toLocalizedTime(item['deletion_date'], long_format=True)">date</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Folder contents section -->
                <tal:folder-contents define="children view/get_children" condition="children">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="ms-2" i18n:translate="">Folder contents</span>
                                </div>
                                <span class="badge bg-secondary" tal:content="python:len(children)">0</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="text-muted p-3 bg-light border-bottom">
                                <span class="ms-1" i18n:translate="">
                                    These items were contained in this folder when it was deleted. 
                                    You can restore them individually to any location.
                                </span>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th i18n:translate="">Title</th>
                                            <th i18n:translate="">Type</th>
                                            <th i18n:translate="">Original path</th>
                                            <th i18n:translate="">Size</th>
                                            <th i18n:translate="">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr tal:repeat="child children">
                                            <td>
                                                <span tal:content="child/title">Title</span>
                                            </td>
                                            <td>
                                                <span class="badge rounded-pill bg-light text-dark border" tal:content="child/type">Type</span>
                                            </td>
                                            <td class="text-monospace small">
                                                <span tal:content="child/path">Path</span>
                                            </td>
                                            <td>
                                                <span tal:content="python:view.format_size(child.get('size', 0))">Size</span>
                                            </td>
                                            <td>
                                                <form method="post" tal:attributes="action string:${context/absolute_url}/@@recyclebin-item/${view/item_id}"
                                                      class="row g-2">
                                                    <input tal:replace="structure context/@@authenticator/authenticator" />
                                                    <input type="hidden" name="child_id" tal:attributes="value child/id" />
                                                    <div class="col-8">
                                                        <input type="text" name="target_path" 
                                                               tal:attributes="placeholder child/parent_path"
                                                               title="Enter target path or leave empty to restore to original location"
                                                               i18n:attributes="title;placeholder"
                                                               class="form-control form-control-sm target-path-input"
                                                               required="required" />
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="submit" name="restore.child" 
                                                                class="btn btn-sm btn-success w-100 restore-child-button"
                                                                i18n:translate="">
                                                            <span class="ms-1">Restore</span>
                                                        </button>
                                                    </div>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </tal:folder-contents>
                
                <!-- Comments tree section -->
                <tal:comments-tree define="comments view/get_comment_children" 
                                   condition="python:item.get('type') == 'CommentTree' and comments">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="ms-2" i18n:translate="">Comment thread contents</span>
                                </div>
                                <span class="badge bg-secondary" tal:content="python:len(comments)">0</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="text-muted p-3 bg-light border-bottom">
                                <span class="ms-1" i18n:translate="">
                                    This comment thread contains the following comments.
                                    All comments will be restored together with their reply relationships.
                                </span>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th i18n:translate="">Author</th>
                                            <th i18n:translate="">Comment text</th>
                                            <th i18n:translate="">In reply to</th>
                                            <th i18n:translate="">Created</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr tal:repeat="comment comments">
                                            <td>
                                                <span class="ms-1" tal:content="comment/author">Author</span>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 300px;" tal:content="comment/text">Comment text</div>
                                            </td>
                                            <td>
                                                <span tal:condition="comment/in_reply_to">
                                                    <span class="ms-1" tal:content="comment/in_reply_to">1234</span>
                                                </span>
                                                <span tal:condition="not:comment/in_reply_to" class="text-muted" i18n:translate="">
                                                    Top level comment
                                                </span>
                                            </td>
                                            <td>
                                                <span class="ms-1" tal:content="python:context.restrictedTraverse('@@plone').toLocalizedTime(comment.get('creation_date'), long_format=True)">Date</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </tal:comments-tree>
            </div>
        </tal:item>
    </div>
</metal:main>

<metal:js fill-slot="javascript_head_slot">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Enable restore buttons when path inputs are filled in
    const targetPathInputs = document.querySelectorAll('.target-path-input');
    
    targetPathInputs.forEach(input => {
        const updateButtonState = () => {
            const button = input.closest('form').querySelector('.restore-child-button');
            if (input.value.trim() !== '') {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        };
        
        // Initial state
        updateButtonState();
        
        // Update on input changes
        input.addEventListener('input', updateButtonState);
        
        // If the input has a placeholder, enable using the placeholder value
        if (input.placeholder) {
            const useDefaultBtn = document.createElement('button');
            useDefaultBtn.type = 'button';
            useDefaultBtn.className = 'btn btn-link btn-sm p-0 mt-1';
            useDefaultBtn.textContent = translate('Use original location');
            useDefaultBtn.style.fontSize = '0.8em';
            useDefaultBtn.onclick = function() {
                input.value = input.placeholder;
                updateButtonState();
            };
            
            // Insert after the input
            input.parentNode.appendChild(useDefaultBtn);
        }
    });
  });
  
  // Simple translation function
  function translate(text) {
    // This could be expanded later to use a proper i18n solution
    // For now, it just returns the text as-is
    return text;
  }
</script>
</metal:js>

</body>
</html>
